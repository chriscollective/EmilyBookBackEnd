<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:og="http://ogp.me/ns#"
  xmlns:fb="http://www.facebook.com/2008/fbml"
>
  <head>
    <title>Emily Books Agency</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/x-icon"
      href="/Images/Index_images/favicon.png"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/Scripts/blockUI.js" type="text/javascript"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <!-- CSS Link -->
    <link rel="stylesheet" href="./NewCss/base.css" />
    <link rel="stylesheet" href="./NewCss/layout.css" />
    <link rel="stylesheet" href="./NewCss/modules.css" />

    <!-- JavaScript Link -->
    <script
      src="/Scripts/LoginPage/Logout.js?t=638969333249704447"
      type="text/javascript"
    ></script>

    <script
      src="https://cdn.tiny.cloud/1/nco3yvd11i1byyx7mvhvcyqlrktst3i2r7o7qbjg4g8vaujm/tinymce/6/tinymce.min.js"
      referrerpolicy="origin"
    ></script>

    <script src="/Scripts/ajaxfileupload.js" type="text/javascript"></script>
    <script type="text/javascript">
      // ----------------------------------------
      // ğŸ§© æ¨¡å¼è¨­å®šï¼štrue = å‡è³‡æ–™æ¨¡å¼ï¼›false = æ­£å¸¸æ¨¡å¼
      // ----------------------------------------
      var isMockMode = true;

      // å–å¾— URL åƒæ•¸
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      var AID = getQueryParam("AID") || "0";

      // ----------------------------------------
      // ğŸ§± å‡è³‡æ–™åº«
      // ----------------------------------------
      var mockAuthors = [
        {
          AID: "1",
          AuthorFirstName: "Haruki",
          AuthorLastName: "Murakami",
          AuthorOriginalLanguageName: "æ‘ä¸Šæ˜¥æ¨¹",
          AuthorRegionCountry: "Japan",
          AuthorDescription:
            "<p>æ—¥æœ¬å°èªªå®¶ï¼Œä»£è¡¨ä½œã€ŠæŒªå¨çš„æ£®æ—ã€‹ã€ã€Š1Q84ã€‹ã€‚</p>",
          AuthorPhoto: "./image/mock_author1.jpg",
          Create_Who2: "Editor01",
          Craete_When2: "2024/10/12",
        },
        {
          AID: "2",
          AuthorFirstName: "Alice",
          AuthorLastName: "Walker",
          AuthorOriginalLanguageName: "ã‚¢ãƒªã‚¹ãƒ»ã‚¦ã‚©ãƒ¼ã‚«ãƒ¼",
          AuthorRegionCountry: "United States",
          AuthorDescription: "<p>ç¾åœ‹å°èªªå®¶ï¼Œä»£è¡¨ä½œã€Šç´«è‰²å§Šå¦¹èŠ±ã€‹ã€‚</p>",
          AuthorPhoto: "./image/mock_author2.jpg",
          Create_Who2: "Admin",
          Craete_When2: "2024/09/01",
        },
        {
          AID: "3",
          AuthorFirstName: "Kim",
          AuthorLastName: "Young-ha",
          AuthorOriginalLanguageName: "ê¹€ì—°í•˜",
          AuthorRegionCountry: "South Korea",
          AuthorDescription: "<p>éŸ“åœ‹ç•¶ä»£å°èªªå®¶ï¼Œé¢¨æ ¼å¤šè®Šã€‚</p>",
          AuthorPhoto: "./image/mock_author3.jpg",
          Create_Who2: "Editor02",
          Craete_When2: "2024/11/05",
        },
        {
          AID: "4",
          AuthorFirstName: "FranÃ§oise",
          AuthorLastName: "Sagan",
          AuthorOriginalLanguageName: "ãƒ•ãƒ©ãƒ³ã‚½ãƒ¯ãƒ¼ã‚ºãƒ»ã‚µã‚¬ãƒ³",
          AuthorRegionCountry: "France",
          AuthorDescription:
            "<p>æ³•åœ‹å°èªªå®¶ï¼Œä»£è¡¨ä½œã€Šä½ å¥½ï¼Œæ†‚æ„ã€‹ï¼ˆBonjour Tristesseï¼‰ã€‚</p>",
          AuthorPhoto: "./image/mock_author4.jpg",
          Create_Who2: "Staff",
          Craete_When2: "2024/08/28",
        },
        {
          AID: "5",
          AuthorFirstName: "Li",
          AuthorLastName: "Bai",
          AuthorOriginalLanguageName: "æç™½",
          AuthorRegionCountry: "China",
          AuthorDescription:
            "<p>å”ä»£è©©äººï¼Œå­—å¤ªç™½ï¼Œä»£è¡¨ä½œã€Šå°‡é€²é…’ã€‹ã€ã€Šæ—©ç™¼ç™½å¸åŸã€‹ç­‰ã€‚</p>",
          AuthorPhoto: "./image/mock_author5.jpg",
          Create_Who2: "System",
          Craete_When2: "2024/07/15",
        },
      ];

      // ----------------------------------------
      // ğŸ§½ æ¸…ç©ºè¡¨å–®ï¼ˆfor æ–°å¢ä½œè€…ï¼‰
      // ----------------------------------------
      function clearForm() {
        $(".fields").val("");
        $(".htmlfields").each(function () {
          const editor = tinymce.get(this.id);
          if (editor) editor.setContent("");
        });
      }

      /*é è¼‰åœ–ç‰‡*/
      function preloadImage(url, imgElement) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            imgElement.src = url;
            resolve();
          };
          img.onerror = () => {
            // å¦‚æœåœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œé¡¯ç¤ºé è¨­åœ–
            imgElement.src = "/image/portrait.png";
            resolve();
          };
          img.src = url;
        });
      }

      // ----------------------------------------
      // ğŸ§  ä¸»å‡½å¼ï¼šå–å¾—ä½œè€…è³‡æ–™
      // ----------------------------------------
      function GetData() {
        if (isMockMode) {
          console.log("ğŸ“˜ å‡è³‡æ–™æ¨¡å¼å•Ÿå‹•ä¸­ (AID=" + AID + ")");

          if (AID === "0") {
            // ğŸ†• æ–°å¢ä½œè€…æ¨¡å¼ï¼šç›´æ¥é¡¯ç¤º portrait.png
            clearForm();
            $("#AuthorProfilePic").attr("src", "/image/portrait.png").show(); // ç›´æ¥é¡¯ç¤ºï¼Œä¸é–ƒ
            return;
          }

          // âœï¸ ç·¨è¼¯ä½œè€…æ¨¡å¼
          var rw = mockAuthors.find((a) => a.AID === AID);
          if (!rw) {
            alert("âš ï¸ æ‰¾ä¸åˆ°å°æ‡‰çš„å‡è³‡æ–™ AID=" + AID);
            return;
          }

          fillFields(rw);
        } else {
          // âš™ï¸ æ­£å¸¸æ¨¡å¼ï¼ˆé€£ç·šä¼ºæœå™¨ï¼‰
          $.post(
            "/Authors/AuthorLib.aspx",
            { Proc: "GetAuthorData", AID: AID },
            function (data) {
              var tb = $.parseJSON(data);
              if (tb.length > 0) {
                var rw = tb[0];
                fillFields(rw);
              }
            }
          );
        }
      }

      // ----------------------------------------
      // âœï¸ å¡«å…¥æ¬„ä½å…§å®¹ï¼ˆfor ç·¨è¼¯ä½œè€…ï¼‰
      // ----------------------------------------
      function fillFields(rw) {
        $(".fields").each(function () {
          $(this).val(rw[this.id] || "");
        });

        // âœ… æ”¹é€²ï¼šå…ˆé åŠ è¼‰åœ–ç‰‡ï¼Œå†è¨­ç½® src
        const profilePic = $("#AuthorProfilePic")[0];
        if (rw.AuthorPhoto && rw.AuthorPhoto !== "") {
          preloadImage(rw.AuthorPhoto, profilePic);
        } else {
          profilePic.src = "/image/portrait.png";
        }

        $(".htmlfields").each(function () {
          const editor = tinymce.get(this.id);
          if (editor) editor.setContent(rw[this.id] || "");
        });
      }

      // ----------------------------------------
      // ğŸª¶ TinyMCE åˆå§‹åŒ–å¾ŒåŸ·è¡Œ GetData()
      // ----------------------------------------
      $(document).ready(function () {
        if (typeof tinymce !== "undefined") {
          let editorInitCount = 0;
          const totalEditors = $(".htmlfields").length;

          tinymce.init({
            selector: ".htmlfields",
            height: 200,
            menubar: false,
            branding: false,
            elementpath: false,
            plugins: "lists link code",
            toolbar:
              "undo redo | bold italic underline | bullist numlist | link | code",
            setup: function (editor) {
              editor.on("init", function () {
                editorInitCount++;
                console.log(
                  `ğŸ§  ${editor.id} åˆå§‹åŒ–å®Œæˆ (${editorInitCount}/${totalEditors})`
                );

                if (editorInitCount === totalEditors) {
                  console.log(
                    "âœ… æ‰€æœ‰ TinyMCE ç·¨è¼¯å™¨åˆå§‹åŒ–å®Œæˆï¼Œé–‹å§‹è¼‰å…¥è³‡æ–™..."
                  );
                  GetData();
                }
              });
            },
          });

          // å–å¾—ç¶²å€åƒæ•¸
          function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
          }

          $(document).ready(function () {
            const from = getQueryParam("from") || "list";
            const BookUID = getQueryParam("BookUID") || "0";
            const backBtn = document.querySelector(".BacktoListCss");

            if (backBtn) {
              if (from === "selection") {
                backBtn.href = `AuthorSelection.html?UID=${BookUID}`;
              } else {
                backBtn.href = "PublishedAuthorCreateUpdateSearch.html";
              }
              if (!from && document.referrer.includes("AuthorSelection")) {
                backBtn.href = document.referrer;
              }
            }
          });
        } else {
          GetData();
        }
      });
    </script>
  </head>
  <body>
    <div class="topnav">
      <div class="AccountInfoCss">
        Welcome <span id="FullName">Bruce</span>
        <button class="LogOutButtonCss" onclick="logout()">Log Out</button>
      </div>

      <div class="navbar">
        <div class="LogoWrap">
          <a href="https://www.emilybooksagency.com/index.aspx">
            <img src="./image/EmilyAgencyLogo.png" class="Site_Title_Logo" />
          </a>
        </div>
        <div class="PageNav_Wrap">
          <a href="./index.html">Book List</a>
          <a href="./PublishedAuthorCreateUpdateSearch.html">Author List</a>
          <a href="./PublishedCoAgentsCreateUpdate.html">CoAgents List</a>
          <a href="./CatalogCreateSearch.html">Catalog List</a>
          <a href="./AboutEmilyCreateSearch.html">Emily Info Edit</a>
        </div>
      </div>
    </div>

    <div id="app">
      <div class="main">
        <div class="MainTitleDesc TitleofThisPage">Author Information</div>
        <a class="DelPubButtonCss" onclick="UpdateAuthorDelData();">Delete</a>
        <a class="BacktoListCss">Go back</a>
        <div class="container">
          <div class="col-50">
            <div class="row">
              <div class="col-50">
                <div class="row">
                  <div class="col-40">
                    <div class="AuthorPic">
                      <div class="BookCoverDivCss">
                        <label
                          class="bookCoverUploadCSs"
                          for="BookCoverOnChange"
                        >
                          <div class="upload-cover-wrapper">
                            <img
                              id="AuthorProfilePic"
                              class="imgfields"
                              alt="Author Photo Preview"
                            />
                            <span class="upload-text">Upload Author Photo</span>
                          </div>
                        </label>
                        <input
                          type="file"
                          name="BookCoverOnChange"
                          id="BookCoverOnChange"
                          onchange="uploadImage(this);"
                          style="display: none"
                        />
                      </div>
                    </div>
                  </div>
                  <div class="col-60">
                    <label for="AuthorLastName"> Author Last Name</label>
                    <input
                      type="text"
                      id="AuthorLastName"
                      class="fields"
                      name="AuthorLastName"
                    />
                    <label for="AuthorFirstName"> Author First Name</label>
                    <input
                      type="text"
                      id="AuthorFirstName"
                      class="fields"
                      name="AuthorFirstName"
                    />
                  </div>
                </div>
              </div>
              <div class="col-50">
                <label for="AuthorOriginalLanguageName">
                  Author Original Language Name</label
                >
                <input
                  type="text"
                  id="AuthorOriginalLanguageName"
                  class="fields"
                  name="AuthorOriginalLanguageName"
                />
                <label for="AuthorRegionCountry"> Author's Country</label>
                <select
                  id="AuthorRegionCountry"
                  class="fields"
                  name="AuthorRegionCountry"
                >
                  <option value="">Select</option>
                  <option value="China">China</option>
                  <option value="France">France</option>
                  <option value="Germany">Germany</option>
                  <option value="Indonesia">Indonesia</option>
                  <option value="Italy">Italy</option>
                  <option value="Japan">Japan</option>
                  <option value="South Korea">South Korea</option>
                  <option value="Spain">Spain</option>
                  <option value="Taiwan">Taiwan</option>
                  <option value="Turkey">Turkey</option>
                  <option value="United States">United States</option>
                  <option value="UK">UK</option>
                </select>
              </div>
            </div>
            <div class="TxtBoxCss">
              <label for="AuthorDescription"> Author Description</label>
              <textarea
                id="AuthorDescription"
                class="htmlfields"
                name="AuthorDescription"
                style="height: 200px"
              ></textarea>
            </div>
          </div>
          <div class="save-container">
            <button class="SubmitBTN btn" onclick="UpdateData();">
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        // åˆå§‹åŒ–è¼‰å…¥
        GetData();

        // æ•æ‰æ‰€æœ‰å¸¶ data-page çš„é€£çµ
        $(document).on("click", "a[data-page]", function (e) {
          e.preventDefault();
          const url = $(this).attr("href");

          // æ·¡å‡ºç›®å‰å…§å®¹
          $("#app").fadeOut(150, function () {
            // è¼‰å…¥æ–°é é¢çš„ä¸»è¦å…§å®¹ï¼ˆåªå– .main è£¡çš„éƒ¨åˆ†ï¼‰
            $("#app").load(url + " .main", function () {
              $("#app").fadeIn(200);
              console.log("âœ… å·²è¼‰å…¥:", url);

              // å¦‚æœæ–°é é¢ä¹Ÿæœ‰è‡ªå·±çš„ JS åˆå§‹åŒ–ï¼Œé€™è£¡å†å‘¼å«å®ƒ
              if (typeof GetData === "function") {
                try {
                  GetData(); // å˜—è©¦å‘¼å«é é¢å…§çš„åˆå§‹åŒ–å‡½å¼
                } catch (err) {
                  console.warn("No GetData() found in", url);
                }
              }
            });
          });
        });
      });
    </script>
  </body>
</html>
