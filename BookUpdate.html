<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:og="http://ogp.me/ns#"
  xmlns:fb="http://www.facebook.com/2008/fbml"
>
  <head>
    <title>Emily Books Agency</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/x-icon"
      href="/Images/Index_images/favicon.png"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="/Scripts/blockUI.js" type="text/javascript"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <!-- CSS Link -->
    <link rel="stylesheet" href="./NewCss/base.css" />
    <link rel="stylesheet" href="./NewCss/layout.css" />
    <link rel="stylesheet" href="./NewCss/modules.css" />

    <!-- JavaScript Link -->

    <script
      src="/Scripts/LoginPage/Logout.js?t=638970021040248488"
      type="text/javascript"
    ></script>

    <script
      src="https://cdn.tiny.cloud/1/nco3yvd11i1byyx7mvhvcyqlrktst3i2r7o7qbjg4g8vaujm/tinymce/6/tinymce.min.js"
      referrerpolicy="origin"
    ></script>

    <script src="/Scripts/ajaxfileupload.js" type="text/javascript"></script>
    <script src="/Scripts/yearGenerator.js" type="text/javascript"></script>
    <script
      src="/Scripts/BehindTheScene/BookCreateJS/BookCoverUpload.js"
      type="text/javascript"
    ></script>

    <script
      src="/Scripts/BehindTheScene/BookCreateJS/BookDelUpdateJS.js"
      type="text/javascript"
    ></script>
    <script
      src="/Scripts/BehindTheScene/BookCreateJS/PublishDetermineJS.js"
      type="text/javascript"
    ></script>

    <!--Book JS-->
    <script type="text/javascript">
      // --------------------------------------------------
      // 🔄 模式切換：true = 假資料模式；false = 正常連線模式
      // --------------------------------------------------
      var isMockMode = true;

      // 從網址抓 UID
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      var UID = getQueryParam("UID") || "0";

      // 替作者連結動態加入 UID
      $(document).ready(function () {
        const authorLink = document.getElementById("editAuthorsLink");
        if (authorLink) {
          authorLink.href = `./AuthorSelection.html?UID=${UID}`;
        }
      });

      // --------------------------------------------------
      // 🧩 假資料庫
      // --------------------------------------------------
      var mockBooks = [
        {
          UID: "1",
          BookTitle: "The Whispering Forest",
          BookSubtitle: "A Tale of Magic and Courage",
          BookOriginalLanguageTitle: "森のささやき",
          BookSeries: "Legends of Greenwind",
          BookPageNumber: "312",
          BookCopyRightYear: "2023",
          ISBNidentifier: "9781111111111",
          IllustratorName: "Mika Tanaka",
          Publisher: "DreamLeaf Press",
          BookGenre: "Fiction",
          BookOriginalLanguage: "Japanese",
          BookGenre2: "Fantasy",
          BookFormat: "Hardback",
          AuthorFirstName: "Alice",
          AuthorLastName: "Sun",
          PublishDecision_Who2: "Mock Editor",
          PublishDecision_When2: "2025/01/10",
          BookDescription:
            "<p>A young girl ventures into the whispering woods to find her destiny.</p>",
          BookMarketingRightsInformation:
            "<p>Exclusive rights in Asia and North America.</p>",
          BookReviews:
            "<p>★★★★☆ — A beautifully written tale full of heart and imagination.</p>",
          EmilyNotes:
            "<p>Strong narrative voice. Potential for series expansion.</p>",
          BookCover: "./image/mock_cover1.jpg",
        },
        {
          UID: "2",
          BookTitle: "Echoes Beyond the Stars",
          BookSubtitle: "Journey Through the Cosmic Unknown",
          BookOriginalLanguageTitle: "星の彼方の響き",
          BookSeries: "Galactic Symphony",
          BookPageNumber: "421",
          BookCopyRightYear: "2024",
          ISBNidentifier: "9782222222222",
          IllustratorName: "Kenji Arai",
          Publisher: "Skyline Publications",
          BookGenre: "Fiction",
          BookOriginalLanguage: "Japanese",
          BookGenre2: "Sci-Fi",
          BookFormat: "Paperback",
          AuthorFirstName: "Bob",
          AuthorLastName: "Moon",
          PublishDecision_Who2: "Mock Editor",
          PublishDecision_When2: "2025/02/20",
          BookDescription:
            "<p>An astronaut hears ancient songs from deep space that may change humanity forever.</p>",
          BookMarketingRightsInformation:
            "<p>Film rights optioned by Mock Studios.</p>",
          BookReviews: "<p>★★★★★ — A masterpiece of speculative fiction.</p>",
          EmilyNotes:
            "<p>Needs translation review. Possible for international launch.</p>",
          BookCover: "./image/mock_cover2.jpg",
        },
        {
          UID: "3",
          BookTitle: "The Glass City",
          BookSubtitle: "Reflections of a Transparent World",
          BookOriginalLanguageTitle: "透明都市",
          BookSeries: "Future Chronicles",
          BookPageNumber: "280",
          BookCopyRightYear: "2022",
          ISBNidentifier: "9783333333333",
          IllustratorName: "Emma Lee",
          Publisher: "Crystal Ink House",
          BookGenre: "Non-Fiction",
          BookOriginalLanguage: "English",
          BookGenre2: "Philosophy",
          BookFormat: "Hardback",
          AuthorFirstName: "Catherine",
          AuthorLastName: "Leaf",
          PublishDecision_Who2: "Mock Editor",
          PublishDecision_When2: "2025/03/15",
          BookDescription:
            "<p>An exploration of privacy and transparency in modern society.</p>",
          BookMarketingRightsInformation:
            "<p>Rights open for EU distribution.</p>",
          BookReviews:
            "<p>★★★★☆ — A thought-provoking journey through the ethics of openness.</p>",
          EmilyNotes:
            "<p>Highly relevant to current socio-political discussions.</p>",
          BookCover: "./image/mock_cover3.jpg",
        },
        {
          UID: "4",
          BookTitle: "Ocean of Dreams",
          BookSubtitle: "Tides of Hope and Despair",
          BookOriginalLanguageTitle: "夢の海",
          BookSeries: "Mariner’s Tales",
          BookPageNumber: "354",
          BookCopyRightYear: "2021",
          ISBNidentifier: "9784444444444",
          IllustratorName: "Sophia Chen",
          Publisher: "Blue Horizon Media",
          BookGenre: "Fiction",
          BookOriginalLanguage: "Chinese",
          BookGenre2: "Drama",
          BookFormat: "Paperback",
          AuthorFirstName: "Daniel",
          AuthorLastName: "Wave",
          PublishDecision_Who2: "Mock Editor",
          PublishDecision_When2: "2025/04/18",
          BookDescription:
            "<p>A sailor confronts the ghosts of his past across the endless sea.</p>",
          BookMarketingRightsInformation:
            "<p>Worldwide publishing rights secured.</p>",
          BookReviews:
            "<p>★★★★☆ — Deeply emotional and vividly cinematic storytelling.</p>",
          EmilyNotes:
            "<p>Consider highlighting maritime symbolism in marketing.</p>",
          BookCover: "./image/mock_cover4.jpg",
        },
        {
          UID: "5",
          BookTitle: "Chronicles of the Forgotten Garden",
          BookSubtitle: "The Seeds of Time",
          BookOriginalLanguageTitle: "忘れられた庭園",
          BookSeries: "Botanical Legends",
          BookPageNumber: "198",
          BookCopyRightYear: "2025",
          ISBNidentifier: "9785555555555",
          IllustratorName: "Yuki Morimoto",
          Publisher: "Verdant Tales Co.",
          BookGenre: "Picture Books",
          BookOriginalLanguage: "Japanese",
          BookGenre2: "Nature",
          BookFormat: "Hardback",
          AuthorFirstName: "Evelyn",
          AuthorLastName: "Stone",
          PublishDecision_Who2: "Mock Editor",
          PublishDecision_When2: "2025/05/25",
          BookDescription:
            "<p>An illustrated journey through a mystical garden lost in time.</p>",
          BookMarketingRightsInformation:
            "<p>Exclusive exhibition tie-in rights available.</p>",
          BookReviews: "<p>★★★★★ — A visual and emotional masterpiece.</p>",
          EmilyNotes:
            "<p>Potential candidate for award submission. Prepare press kit.</p>",
          BookCover: "./image/mock_cover5.jpg",
        },
      ];

      // --------------------------------------------------
      // 🧠 主函式：取得書籍資料
      // --------------------------------------------------
      function GetData() {
        if (isMockMode) {
          console.log("🧩 假資料模式啟動中 (UID=" + UID + ")");
          var rw = mockBooks.find((b) => b.UID === UID);
          if (!rw) {
            alert("未找到對應的假資料 UID=" + UID);
            return;
          }

          // 普通輸入欄位
          $(".fields").each(function () {
            $(this).val(rw[this.id] || "");
          });

          // 圖片欄位
          $(".imgfields").each(function () {
            $(this).attr("src", rw[this.id] || "./Images/no_image.png");
          });

          // TinyMCE 富文字欄位
          $(".htmlfields").each(function () {
            var editor = tinyMCE.get(this.id);
            if (editor) {
              editor.setContent(rw[this.id] || "");
            } else {
              console.warn("⚠️ 找不到 TinyMCE 編輯器:", this.id);
            }
          });

          // 作者資訊
          // --------------------------------------------------
          // 🧾 顯示作者資訊（支援多位作者、同步 localStorage）
          // --------------------------------------------------
          var selectedAuthors = JSON.parse(
            localStorage.getItem("selectedAuthors_" + UID)
          );

          if (selectedAuthors && selectedAuthors.length > 0) {
            var htmlString = "";
            selectedAuthors.forEach((a) => {
              htmlString +=
                '<div class="AuthorNameCss">' +
                a.AuthorFirstName +
                " " +
                a.AuthorLastName +
                "</div><hr class='AuthorHR'>";
            });
            $("#BookAuthors").html(htmlString);
          } else {
            // 沒有 localStorage 記錄，顯示預設作者
            var htmlString =
              '<div class="AuthorNameCss">' +
              rw.AuthorFirstName +
              " " +
              rw.AuthorLastName +
              "</div><hr class='AuthorHR'>";
            $("#BookAuthors").html(htmlString);
          }
        } else {
          // --------------------------------------------------
          // 🖥️ 正常模式（連線伺服器）
          // --------------------------------------------------
          $.post(
            "/Books/BooksLib.aspx",
            { Proc: "GetBookDataTiny", UID: UID },
            function (data) {
              var tb = $.parseJSON(data);
              if (tb.length > 0) {
                var rw = tb[0];

                $(".fields").each(function () {
                  $(this).val(rw[this.id]);
                });
                $(".imgfields").each(function () {
                  $(this).attr("src", rw[this.id]);
                });
                $(".htmlfields").each(function () {
                  tinyMCE.get(this.id).setContent(rw[this.id]);
                });

                $.post(
                  "/Books/BooksLib.aspx",
                  { Proc: "GetGroupBookAuthorData", UID: UID },
                  function (data) {
                    var tb = $.parseJSON(data);
                    var htmlString = "";
                    if (tb.length > 0) {
                      for (var i = 0; i < tb.length; i++) {
                        var rws = tb[i];
                        htmlString +=
                          '<div class="AuthorNameCss">' +
                          rws.AuthorFirstName +
                          " " +
                          rws.AuthorLastName +
                          "</div><hr class='AuthorHR'>";
                      }
                      $("#BookAuthors").html(htmlString);
                    }
                  }
                );
              }
            }
          );
        }
      }

      // --------------------------------------------------
      // 🪶 TinyMCE 初始化完成後才執行 GetData
      // --------------------------------------------------
      $(document).ready(function () {
        if (typeof tinymce !== "undefined") {
          let editorInitCount = 0;
          const totalEditors = $(".htmlfields").length;

          tinymce.init({
            selector: ".htmlfields",
            height: 200,
            menubar: false,
            branding: false,
            elementpath: false,
            plugins: "lists link code",
            toolbar:
              "undo redo | bold italic underline | bullist numlist | link | code",
            setup: function (editor) {
              editor.on("init", function () {
                editorInitCount++;
                console.log(
                  `🧠 ${editor.id} 初始化完成 (${editorInitCount}/${totalEditors})`
                );

                // ✨ 等全部編輯器都準備好，再載入資料
                if (editorInitCount === totalEditors) {
                  console.log(
                    "✅ 所有 TinyMCE 編輯器初始化完成，開始載入假資料..."
                  );
                  GetData();
                }
              });
            },
          });
        } else {
          GetData();
        }
      });

      // --------------------------------------------------
      // ✏️ 更新資料（原版保留）
      // --------------------------------------------------
      function UpdateData() {
        var obj = {};
        $(".fields").each(function () {
          obj[this.id] = $(this).val();
        });
        obj.BookDescription = encodeURI(
          tinyMCE.get("BookDescription").getContent()
        );
        obj.BookMarketingRightsInformation = encodeURI(
          tinyMCE.get("BookMarketingRightsInformation").getContent()
        );
        obj.BookReviews = encodeURI(tinyMCE.get("BookReviews").getContent());
        obj.EmilyNotes = encodeURI(tinyMCE.get("EmilyNotes").getContent());
        obj.UID = UID;

        if (isMockMode) {
          console.log("🧩 模擬更新：", obj);
          alert("假資料模式下，資料未送出。");
        } else {
          $.post(
            "/Books/BooksLib.aspx",
            { Proc: "UpdateBookData", jsonString: JSON.stringify(obj) },
            function (data) {
              var obj = $.parseJSON(data);
              alert(obj.Message);
              if (obj.Success && UID == "0") {
                UID = obj.UID.toString();
              }
            }
          );
        }
      }

      // --------------------------------------------------
      // 📸 上傳圖片（原版保留）
      // --------------------------------------------------
      function uploadImage(self) {
        var $this = $(self);
        if ($this.val() == "") {
          alert("請選擇要上傳的檔案!!");
          return;
        }
        var fileType = ["jpg", "png", "gif", "PNG", "jpeg"];
        var filename = $this.val().split(".");
        var extname = filename[filename.length - 1];

        if (fileType.indexOf(extname) >= 0) {
          if (isMockMode) {
            alert("假資料模式下不會真的上傳檔案。");
          } else {
            MemberPhotoUpload();
          }
        } else {
          alert("請上傳 jpg, png, gif 檔！");
        }
      }

      function MemberPhotoUpload() {
        $.ajaxFileUpload({
          url: "/Books/BooksLib.aspx",
          type: "post",
          data: { Proc: "MemberPhotoUpload", UID: UID },
          secureuri: false,
          fileElementId: "BookCoverOnChange",
          dataType: "text",
          success: function (data, status) {
            var obj = $.parseJSON(data);
            alert(obj.Message);
            $("#output").attr("src", obj.imgPath);
          },
          error: function (data, status, e) {
            alert(e);
          },
        });
      }
    </script>
  </head>
  <body>
    <div class="topnav">
      <div class="AccountInfoCss">
        Welcome <span id="FullName">Bruce</span>
        <button class="LogOutButtonCss" onclick="logout()">Log Out</button>
      </div>

      <div class="navbar">
        <div class="LogoWrap">
          <a href="https://www.emilybooksagency.com/index.aspx">
            <img src="./image/EmilyAgencyLogo.png" class="Site_Title_Logo" />
          </a>
        </div>
        <div class="PageNav_Wrap">
          <a href="./index.html">Book List</a>
          <a href="./PublishedAuthorCreateUpdateSearch.html">Author List</a>
          <a href="./PublishedCoAgentsCreateUpdate.html">CoAgents List</a>
          <a href="./CatalogCreateSearch.html">Catalog List</a>
          <a href="./AboutEmilyCreateSearch.html">Emily Info Edit</a>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="TitleofThisPage">Create / Edit Book Details</div>
      <a class="DelPubButtonCss" onclick="UpdateBookDelData();">Delete</a>
      <a class="DelPubButtonCss" onclick="UpdateBookUnPublishData();"
        >UnPublish it</a
      >
      <a class="DelPubButtonCss" onclick="UpdateBookPublishData();"
        >Publish it</a
      >
      <div class="MainTitleDesc">Book Information</div>
      <a class="BacktoListCss" href="./index.html">Go back</a>
      <div class="container">
        <div class="row">
          <div class="col-100">
            <div class="row">
              <div class="col-60">
                <div class="row">
                  <div class="col-40">
                    <div class="BookCoverDivCss">
                      <label for="BookCoverOnChange" class="upload-cover-label">
                        <div class="upload-cover-wrapper">
                          <img
                            id="BookCover"
                            class="imgfields"
                            alt="BookCover Preview"
                          />
                          <span class="upload-text">Upload Book Cover</span>
                        </div>
                      </label>

                      <input
                        type="file"
                        name="BookCoverOnChange"
                        id="BookCoverOnChange"
                        onchange="uploadImage(this);"
                        style="display: none"
                      />
                    </div>
                  </div>
                  <div class="col-60">
                    <!--INPUT Book's Title-->
                    <label for="BookTitle"> Book Title</label>
                    <input
                      type="text"
                      id="BookTitle"
                      class="fields"
                      name="BookTitle"
                    />
                    <!--INPUT Book's Subtitle-->
                    <label for="BookSubtitle"> Book Subtitle</label>
                    <input
                      type="text"
                      id="BookSubtitle"
                      class="fields"
                      name="BookSubtitle"
                    />
                    <!--INPUT Book's Original Title-->
                    <label for="BookOriginalLanguageTitle">
                      Original Language Title</label
                    >
                    <input
                      type="text"
                      id="BookOriginalLanguageTitle"
                      class="fields"
                      name="BookOriginalLanguageTitle"
                    />
                    <!--INPUT Book's Series-->
                    <label for="BookSeries"> Book Series</label>
                    <input
                      type="text"
                      id="BookSeries"
                      class="fields"
                      name="BookSeries"
                    />

                    <!--INPUT Book's Page Number-->
                    <label for="BookPageNumber"> Page Number</label>
                    <input
                      type="text"
                      id="BookPageNumber"
                      class="fields"
                      name="BookPageNumber"
                    />
                    <!--INPUT Book's Copyright's year-->
                    <label for="BookCopyRightYear"> Copyright Year</label>
                    <input
                      type="text"
                      id="BookCopyRightYear"
                      class="fields"
                      name="BookCopyRightYear"
                    />
                  </div>
                </div>
              </div>
              <div class="col-40">
                <!--INPUT ISBN of the Book-->
                <label for="ISBNidentifier"> ISBN / Identifier</label>
                <input
                  type="text"
                  id="ISBNidentifier"
                  class="fields"
                  name="ISBNidentifier"
                  required
                />
                <!--INPUT Illustrator's Name-->
                <label for="IllustratorName"> Illustrator Name</label>
                <input
                  type="text"
                  id="IllustratorName"
                  class="fields"
                  name="IllustratorName"
                />
                <!--INPUT Publisher-->
                <label for="Publisher"> Publisher</label>
                <input
                  type="text"
                  id="Publisher"
                  class="fields"
                  name="Publisher"
                />

                <div class="row">
                  <div class="col-50">
                    <!--INPUT Book's Genre-->
                    <label for="BookGenre"> Book Genre </label>
                    <select
                      class="fields GenreCSs"
                      id="BookGenre"
                      name="BookGenre"
                    >
                      <option value="">Select</option>
                      <option value="Fiction">Fiction</option>
                      <option value="Non-Fiction">Non-Fiction</option>
                      <option value="Picture Books">Picture Books</option>
                    </select>
                    <!--INPUT Book's Original Language-->
                    <label for="BookOriginalLanguage"> Original Language</label>
                    <select
                      id="BookOriginalLanguage"
                      class="fields"
                      name="BookOriginalLanguage"
                    >
                      <option value="">Select</option>
                      <option value="Japanese">Japanese</option>
                      <option value="Chinese">Chinese</option>
                      <option value="Korean">Korean</option>
                      <option value="English">English</option>
                      <option value="German">German</option>
                      <option value="French">French</option>
                      <option value="Spanish">Spanish</option>
                      <option value="Italian">Italian</option>
                    </select>
                  </div>
                  <div class="col-50">
                    <!--INNPUT Additional Book's Genre-->
                    <label for="BookGenre2"> Other Genre</label>
                    <input
                      type="text"
                      id="BookGenre2"
                      class="fields"
                      name="BookGenre2"
                    />
                    <!--INPUT Book's Format-->
                    <label for="BookFormat"> Binding Format</label>
                    <select id="BookFormat" class="fields" name="BookFormat">
                      <option value="">Select</option>
                      <option value="Hardback">Hardback</option>
                      <option value="Paperback">Paperback</option>
                    </select>
                  </div>
                </div>
                <div class="AuthorTitle">
                  <label for="BookAuthor">
                    Book's Author
                    <br />
                    <a class="AuthorListA" id="editAuthorsLink">
                      Click Here to Edit Author(s)</a
                    ></label
                  >
                </div>
                <div class="AuthorBox">
                  <div id="BookAuthors"></div>
                </div>
              </div>
            </div>

            <div class="TxtBoxCss">
              <!--TextArea Book's Description TINY Mce-->
              <label for="BookDescription"> Description of the Book</label>
              <textarea
                id="BookDescription"
                class="htmlfields"
                name="BookDescription"
              >
              </textarea>
              <!--TextArea Book's <Market/Rights Information TINY Mce-->
              <label for="BookMarketingRightsInformation">
                Marketing Information</label
              >
              <textarea
                id="BookMarketingRightsInformation"
                class="htmlfields"
                name="BookMarketingRightsInformation"
                style="height: 200px"
              >
              </textarea>
              <!--TextArea Book's Reviews TINY Mce-->
              <label for="BookReviews"> Reviews</label>
              <textarea
                id="BookReviews"
                class="htmlfields"
                name="BookReviews"
                style="height: 200px"
              >
              </textarea>
              <!--TextArea Emily's Notes TINY Mce-->
              <label for="EmilyNotes"> Endorsements</label>
              <textarea
                id="EmilyNotes"
                class="htmlfields"
                name="EmilyNotes"
                style="height: 200px"
              >
              </textarea>
            </div>
          </div>
        </div>
        <div class="save-container">
          <button class="SubmitBTN btn" onclick="UpdateData();">
            Save Changes
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
